# 🚀 NextDesk: 桌面终端开发方案

> **核心理念**：外壳即本体 (Shell as the App)。
> 通过 Python + Webview 构建现代化 UI，底层静默调度 Clash 网络引擎与 MultiDesk 渲染引擎，实现“零代码逆向”的深度二次开发。

---

## 🛠️ 1. 技术栈选型 (Tech Stack)
我们采用 **"Hybrid Desktop"** 架构，兼顾 Python 的系统控制力与 React 的极致 UI 表现力。

| 模块              | 技术/工具                   | 核心作用                                        |
| :-------------- | :---------------------- | :------------------------------------------ |
| **前端 (UI)**     | **React + Vite**        | 构建现代化、响应式、暗黑风格的用户界面 (SPA)。                  |
| **组件库**         | **ShadcnUI + Tailwind** | 极速构建现代化UI风格 Dashboard，无需手写 CSS。             |
| **后端 (Logic)**  | **Python 3.10+**        | 负责进程守护、文件生成、API 桥接。                         |
| **容器 (Bridge)** | **Pywebview**           | 轻量级 Web 容器 (基于 WebView2)，连接 Python 与 React。 |
| **RDP 引擎**      | **MultiDesk (魔改版)**     | 负责 RDP 会话管理与渲染 (需修改资源伪装)。                   |
| **网络引擎**        | **Clash Meta (Mihomo)** | 负责链路加速，支持 SOCKS5/TUN 模式。                    |
| **系统交互**        | **pywin32**             | 窗口标题劫持、隐藏控制台、系统级操作。                         |
| **安装制作**        | **Inno Setup**          | 制作安装包，**自动检测并安装 WebView2 环境**。              |

---

## 📂 2. 项目目录结构 (Project Layout)

```text
NextDesk_Project/
├── frontend/                # [前端] React 项目
│   ├── src/
│   │   ├── components/      # UI 组件 (Button, Table...)
│   │   ├── App.tsx          # 主界面逻辑
│   │   └── api.ts           # Python 互操作接口 (window.py)
│   ├── package.json
│   └── vite.config.ts       # 配置 build.outDir 指向 backend/web
│
├── backend/                 # [后端] Python 项目
│   ├── main.py              # 程序入口 (启动 Pywebview)
│   ├── api.py               # 暴露给前端的 Python API 类
│   ├── core/                # 核心业务逻辑
│   │   ├── launcher.py      # 引擎启动器 (Clash/MultiDesk)
│   │   ├── config_gen.py    # XML/YAML 配置文件生成器
│   │   └── sub_loader.py    # 订阅下载与解析
│   ├── web/                 # [自动生成] 前端构建产物 (index.html, assets/)
│   └── bin/                 # [核心] 二进制工具库 (发布时需隐藏)
│       ├── core.dat         # (原 MultiDesk.x64.exe)
│       ├── network.dat      # (原 mihomo.exe)
│       ├── geoip.dat        # IP 数据库
│       └── WebView2Setup.exe# WebView2 离线引导程序
│
├── build.spec               # PyInstaller 打包配置
├── setup.iss                # Inno Setup 安装脚本
└── requirements.txt         # Python 依赖清单
```

---

## ✅ 3. 开发任务清单 (To-Do List)
### Phase 1: 备料与伪装 (Resources & Camouflage)
- [ ] **下载核心组件**：MultiDesk (Portable) 和 Clash Meta (Windows amd64)。
- [ ] **资源魔改 (Resource Hacking)**：
    - [ ] 使用 `Resource Hacker` 修改 `MultiDesk.exe` 图标为 **NextDesk Logo**。
    - [ ] 修改版本信息：Syvik -> **NextDesk Team**。
    - [ ] 重命名：`MultiDesk.x64.exe` -> `backend/bin/core.dat`。
    - [ ] 重命名：`mihomo.exe` -> `backend/bin/network.dat`。
- [ ] **获取环境包**：下载 `MicrosoftEdgeWebview2Setup.exe` 放入根目录。

### Phase 2: 前端开发 (Frontend - React)
- [ ] **初始化**：`npm create vite@latest frontend -- --template react-ts`。
- [ ] **配置 Vite**：
    - [ ] 设置 `base: './'` (适配 Pywebview 本地文件加载)。
    - [ ] 设置 `build.outDir: '../backend/web'`。
- [ ] **UI 实现**：
    - [ ] **Dashboard**：状态仪表盘 (加速引擎状态、延迟)。
    - [ ] **Server List**：使用 ShadcnUI Table 展示服务器，支持搜索/排序。
    - [ ] **Settings**：订阅 URL 输入框，"一键更新" 按钮。
- [ ] **交互逻辑**：
    - [ ] 封装 `window.py.start_session()` 调用。
    - [ ] 封装 `window.py.save_config()` 调用。
### Phase 3: 后端开发 (Backend - Python)
- [ ] **API 桥接 (`api.py`)**：
    - [ ] 实现 `Api` 类，供 JS 调用。
    - [ ] `start_engine()`: 串行启动 Clash -> 生成 XML -> 启动 MultiDesk。
- [ ] **配置生成 (`config_gen.py`)**：
    - [ ] 解析订阅链接，生成 `runtime_clash.yaml`。
    - [ ] 遍历服务器列表，生成 `MultiDesk.multidesk` (XML格式)，强制注入 SOCKS5 (127.0.0.1:7897)。
- [ ] **隐形启动 (`launcher.py`)**：
    - [ ] 使用 `subprocess.Popen` 启动 `core.dat`。
    - [ ] **标题劫持**：启动后循环检测窗口句柄，强制 `SetWindowText("NextDesk Workspace")`。
### Phase 4: 打包与发布 (Packaging)

#### 4.1 PyInstaller 构建
- [ ] 编写 `build.spec`，确保包含 `backend/web` 和 `backend/bin` 目录。
- [ ] 执行 `pyinstaller build.spec` 生成单文件夹产物 (`dist/NextDesk`).

#### 4.2 Inno Setup 制作安装包
- [ ] 编写 `setup.iss` 脚本，集成 **WebView2 自动检测逻辑**。

```pascal
; NextDesk 安装脚本
[Setup]
AppName=NextDesk
AppVersion=1.0.0
DefaultDirName={autopf}\NextDesk
OutputBaseFilename=NextDesk_Setup_v1.0
Compression=lzma2
SolidCompression=yes
PrivilegesRequired=admin

[Files]
; 复制主程序
Source: "dist\NextDesk\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
; 复制 WebView2 引导
Source: "MicrosoftEdgeWebview2Setup.exe"; DestDir: "{tmp}"; Flags: deleteafterinstall

[Icons]
Name: "{autoprograms}\NextDesk"; Filename: "{app}\NextDesk.exe"
Name: "{autodesktop}\NextDesk"; Filename: "{app}\NextDesk.exe"

[Code]
// WebView2 检测与安装逻辑
function InitializeSetup(): Boolean;
var
  ResultCode: Integer;
begin
  Result := True;
  // 检测注册表，若无 WebView2 则运行 MicrosoftEdgeWebview2Setup.exe
  if not RegKeyExists(HKLM, 'SOFTWARE\WOW6432Node\Microsoft\EdgeUpdate\Clients\{F3017226-FE2A-4295-8BDF-00C3A9A7E4C5}') then
  begin
    if MsgBox('NextDesk 运行需要 WebView2 环境，是否自动安装？', mbConfirmation, MB_YESNO) = IDYES then
      ExtractTemporaryFile('MicrosoftEdgeWebview2Setup.exe');
      Exec(ExpandConstant('{tmp}\MicrosoftEdgeWebview2Setup.exe'), '/silent /install', '', SW_SHOW, ewWaitUntilTerminated, ResultCode);
  end;
end;
```

---

## 📦 4. 依赖配置 (Requirements)

### Python (`requirements.txt`)
```text
pywebview==4.4.1       # 核心：Webview 容器
pywin32==306           # 系统 API (标题劫持)
pyyaml==6.0.1          # YAML 处理
requests==2.31.0       # 网络请求
psutil==5.9.5          # 进程管理
packaging==23.1        # 版本号处理
```

### Node.js (`frontend/package.json`)
```json
{
  "dependencies": {
    "react": "^18.2.0",
    "framer-motion": "^10.16.4", 
    "lucide-react": "^0.292.0",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.0.0",
    "tailwind-merge": "^2.0.0"
  },
  "devDependencies": {
    "vite": "^5.0.0",
    "tailwindcss": "^3.3.0",
    "typescript": "^5.2.0"
  }
}
```

---

## 💡 开发小贴士

1.  **调试模式 (HMR)**:
    在开发阶段，Python 代码中设置 `webview.create_window(url='http://localhost:5173')`，这样修改 React 代码可以实时刷新，无需反复打包。
2.  **生产模式**:
    发布前，修改 Python 代码指向本地文件 `webview.create_window(url='web/index.html')`，并执行 `npm run build`。
3.  **防杀毒误报**:
    由于使用了 `pywin32` 劫持窗口和 `subprocess` 启动进程，生成的 EXE 可能会被杀毒软件误报。建议在发布前提交给 360/火绒 进行白名单认证，或给 EXE 进行数字签名。

## 🤖 5. AI 开发最小化原则 (MVP Rules)
- 目标：先打通最小闭环（前端 -> Python API -> 引擎启动 -> UI 状态回显）。
- 范围：只实现启动/停止、订阅解析（Clash 格式）、配置生成（Clash YAML + MultiDesk XML）、最小 UI 状态显示。
- 非目标：不做自动更新、日志平台、多平台适配、复杂加密与权限体系。
- 约束：不新增依赖、不改目录结构、不做大规模重构；如需突破边界必须先确认。
- 验收：点击“启动” -> Clash 启动 -> 生成 XML -> MultiDesk 拉起 -> UI 显示运行状态。